- name: Define Organizations
  theforeman.foreman.organization:
    username: "{{ satellite_user }}"
    password: "{{ satellite_pwd }}"
    server_url: "{{ satellite_url }}"
    validate_certs: "{{ satellite_verify_ssl }}"
    name: "{{ item }}"
  with_items: "{{ organizations | default([]) }}"
  tags:
  - never
  - define-infra

- name: Define domains
  theforeman.foreman.domain:
    name: "{{ item.key }}"
    username: "{{ satellite_user }}"
    password: "{{ satellite_pwd }}"
    server_url: "{{ satellite_url }}"
    validate_certs: "{{ satellite_verify_ssl }}"
    organizations: "{{ item.value.organizations | default(organizations) }}"
    locations: "{{ item.value.locations | default(locations.keys()) | list }}"
    description: "{{ item.value.description }}"
  with_dict: "{{ domains | default([]) }}"
  tags:
  - never
  - define-infra

- name: Define partition tables
  theforeman.foreman.partition_table:
    name: "{{ item.key }}"
    username: "{{ satellite_user }}"
    password: "{{ satellite_pwd }}"
    server_url: "{{ satellite_url }}"
    validate_certs: "{{ satellite_verify_ssl }}"
    layout: "{{ item.value.partition_table }}"
    locations: "{{ item.value.locations | default(locations.keys()) | list }}"
    organizations: "{{ item.value.organizations | default(organizations) }}"
    os_family: "{{ item.value.os_family }}"
    locked: false
  with_dict: "{{ partition_tables | default({}) }}"
  tags:
  - never
  - define-infra

- include: priv_define_provisining_templates.yml
  with_items: "{{ provisioning_templates | default([])}}"
  loop_control:
    loop_var: template_source
  tags:
  - never
  - define-infra

- name: Enable Red Hat Repositories
  theforeman.foreman.repository_set:
    username: "{{ satellite_user }}"
    password: "{{ satellite_pwd }}"
    server_url: "{{ satellite_url }}"
    validate_certs: "{{ satellite_verify_ssl }}"
    name: "{{ item.name }}"
    organization: "{{ satellite_organization }}"
    product: "{{ item.product }}"
    repositories: "{{ item.architectures | default(omit) }}"
    all_repositories: "{{ 'false' if item.architectures is defined else 'true' }}"
    state: enabled
  tags:
  - never
  - define
  - change
  with_items: "{{ redhat_repositories | default([]) }}"

- name: Define Installation Media
  theforeman.foreman.installation_medium:
    name: "{{ item.key }}"
    username: "{{ satellite_user }}"
    password: "{{ satellite_pwd }}"
    server_url: "{{ satellite_url }}"
    validate_certs: "{{ satellite_verify_ssl }}"
    locations: "{{ item.value.locations | default( locations.keys() ) | list }}"
    organizations: "{{ item.value.organizations | default( organizations ) }}"
    os_family: "{{ item.value.os_family }}"
    path: "{{ item.value.path }}"
    state: "{{ item.value.state  | default('present') }}"
  with_dict: "{{ installation_media | default({}) }}"
  tags:
  - never
  - define-infra

- name: "Create Operating Systems (provide default info)"
  theforeman.foreman.operatingsystem:
    username: "{{ satellite_user }}"
    password: "{{ satellite_pwd }}"
    server_url: "{{ satellite_url }}"
    validate_certs: "{{ satellite_verify_ssl }}"
    name: "{{ item.name }}"
    family: "{{ item.family }}"
    architectures: "{{ item.architectures }}"
    media: "{{ item.media | default(omit) }}"
    ptables: "{{ item.ptables }}"
    password_hash: "{{ item.password_hash }}"
    provisioning_templates: "{{ item.provisioning_templates }}"
    major: "{{ item.major }}"
    state: "{{ item.state | default('present') }}"
  with_items: "{{ operating_systems | default([]) }}"
  tags:
  - never
  - define-infra

- include: priv_define_os_template_association.yml
  with_items:
  - "{{ operating_systems | default([]) }}"
  loop_control:
    loop_var: operating_system
  tags:
  - never
  - define-infra

- name: Define subnets
  theforeman.foreman.subnet:
    name: "{{ item.key }}"
    username: "{{ satellite_user }}"
    password: "{{ satellite_pwd }}"
    server_url: "{{ satellite_url }}"
    validate_certs: "{{ satellite_verify_ssl }}"
    network: "{{ item.value.network }}"
    cidr: "{{ item.value.cidr }}"
    mask: "{{ item.value.mask }}"
    gateway: "{{ item.value.gateway }}"
    domains: "{{ item.value.domains | default( domains.keys() ) | list }}"
    organizations: "{{ item.value.organizations | default( organizations ) }}"
    dns_primary: "{{ item.value.dns_primary | default(dns_primary) }}"
    dns_secondary: "{{ item.value.dns_secondary | default(dns_secondary) }}"
    boot_mode: "{{ item.value.boot_mode | default(boot_mode) }}"
    locations: "{{ item.value.locations | default(locations.keys()) | list }}"
    ipam: "{{ item.value.ipam | default(ipam) }}"
  with_dict: "{{ subnets | default({}) }}"
  tags:
  - never
  - define-infra
